{% extends 'supplies/base.html' %}
{% load humanize %}

{% block title %}Finalize Order - SSPMO Virtual Store{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-7">

            <div
                class="d-flex justify-content-center align-items-center mb-4 text-muted small text-uppercase fw-bold letter-spacing-1">
                <span class="text-success"><i class="bi bi-check-circle-fill me-1"></i> Step 1: Draft</span>
                <div class="mx-3 border-top" style="width: 30px;"></div>
                <span class="text-dark"><i class="bi bi-2-circle-fill me-1"></i> Step 2: Upload & Finalize</span>
            </div>

            <div class="card shadow-lg border-0 rounded-4 overflow-hidden">

                <div class="card-header bg-white border-bottom p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="fw-bold text-dark mb-1">Finalize Order #{{ order.id }}</h5>
                            <p class="text-muted small mb-0">Review details and attach signed slip.</p>
                        </div>
                        <span
                            class="badge bg-warning-subtle text-warning-emphasis border border-warning-subtle rounded-pill px-3">
                            {{ order.get_status_display|default:"Draft" }}
                        </span>
                    </div>
                </div>

                <div class="card-body p-0">

                    <div class="bg-light p-4 border-bottom">
                        <div class="row g-3 text-center">
                            <div class="col-4 border-end">
                                <small class="text-muted d-block text-uppercase fw-bold"
                                    style="font-size: 0.65rem; letter-spacing: 1px;">Date Ordered</small>
                                <span class="fw-bold text-dark small">{{ order.created_at|date:"M j, Y" }}</span>
                            </div>
                            <div class="col-4 border-end">
                                <small class="text-muted d-block text-uppercase fw-bold"
                                    style="font-size: 0.65rem; letter-spacing: 1px;">Time</small>
                                <span class="fw-bold text-dark small">{{ order.created_at|date:"h:i A" }}</span>
                            </div>
                            <div class="col-4">
                                <small class="text-muted d-block text-uppercase fw-bold"
                                    style="font-size: 0.65rem; letter-spacing: 1px;">Total Items</small>
                                <span class="fw-bold text-dark small">{{ order.items.count }} Line Item(s)</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-4">
                        <h6 class="fw-bold text-uppercase small text-muted mb-3 letter-spacing-1">Order Summary</h6>

                        <div class="table-responsive">
                            <table class="table table-sm table-borderless align-middle mb-0">
                                <thead class="border-bottom text-muted small text-uppercase"
                                    style="font-size: 0.75rem;">
                                    <tr>
                                        <th class="pb-3 ps-3" style="width: 50%; font-weight: 700;">Product</th>
                                        <th class="pb-3 text-center" style="width: 15%; font-weight: 700;">Qty</th>
                                        <th class="pb-3 text-end" style="width: 15%; font-weight: 700;">Price</th>
                                        <th class="pb-3 text-end pe-3" style="width: 20%; font-weight: 700;">Subtotal
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="small">
                                    {% for item in order.items.all %}
                                    <td class="py-3 ps-3">
                                        <span class="fw-bold text-dark d-block text-truncate" style="max-width: 250px;"
                                            title="{{ item.product.name }}">{{ item.product.name }}</span>
                                    </td>
                                    <td class="py-3 text-center text-secondary">x{{ item.quantity }}</td>
                                    <td class="py-3 text-end text-secondary">₱{{ item.price|floatformat:2|intcomma }}
                                    </td>
                                    <td class="py-3 text-end fw-bold text-dark pe-3">₱{{
                                        item.subtotal|floatformat:2|intcomma }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="border-top bg-light">
                                    <tr>
                                        <td colspan="3"
                                            class="py-3 text-end small text-muted text-uppercase fw-bold align-middle">
                                            Total Amount
                                        </td>
                                        <td class="py-3 text-end fs-5 fw-bold text-success pe-3 align-middle">
                                            ₱{{ order.total_amount|floatformat:2|intcomma }}
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <div class="p-4 bg-light border-top">
                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}

                            <label class="form-label fw-bold small text-uppercase text-muted mb-2">Required
                                Action</label>

                            <div
                                class="card border-dashed border-2 border-secondary-subtle bg-white p-4 text-center mb-4">
                                <div class="mb-3">
                                    <i class="bi bi-cloud-arrow-up text-success display-4"></i>
                                </div>
                                <h6 class="fw-bold text-dark">Upload Signed Requisition Slip</h6>
                                <p class="text-muted small mb-3">Please attach the PDF/Image with your signature.</p>

                                <input type="file" name="document1" id="id_document"
                                    class="form-control form-control-sm w-75 mx-auto" required
                                    accept=".pdf,.jpg,.jpeg,.png">

                                <div class="mt-3 small">
                                    <span class="text-muted">Don't have the file?</span>
                                    <a href="{% url 'requisition_slip_download' order.id %}" target="_blank"
                                        class="fw-bold text-decoration-none">Download Slip Here</a>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg fw-bold shadow-sm"
                                    style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">
                                    <i class="bi bi-check-circle-fill me-2"></i> Confirm & Submit Order
                                </button>
                                <a href="{% url 'view_cart' %}" class="btn btn-light text-muted small">Cancel</a>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Dashed Border Utility */
    .border-dashed {
        border-style: dashed !important;
    }

    .letter-spacing-1 {
        letter-spacing: 1px;
    }

    /* Compact Table Font */
    .table-sm td,
    .table-sm th {
        font-size: 0.85rem;
    }
</style>
{% endblock %}