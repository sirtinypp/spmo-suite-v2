{% extends 'layout.html' %}
{% load humanize %}

{% block content %}

<div id="preview-overlay">
    
    <div class="preview-controls no-print">
        <div class="d-flex justify-content-between align-items-center w-100 max-w-A4 mx-auto">
            <div class="text-white fw-bold">
                <i class="fas fa-file-invoice me-2"></i>Service Record (Portrait)
            </div>
            <div>
                <button onclick="window.close()" class="btn btn-sm btn-outline-light me-2">
                    <i class="fas fa-times me-1"></i> Close
                </button>
                <button onclick="window.print()" class="btn btn-sm btn-primary">
                    <i class="fas fa-print me-1"></i> Print
                </button>
            </div>
        </div>
    </div>

    <div id="print-area">
        
        <div class="print-header">
            <h4>University of the Philippines</h4>
            <h5>System Supply and Property Management Office</h5>
            <br>
            <h3>- Service & Maintenance Record -</h3>
        </div>

        <div class="print-meta">
            <div class="row-meta">
                <span class="label">Entity Name:</span> 
                <span class="value border-bottom-line">{{ asset.name }}</span>
            </div>
            <div class="row-meta">
                <span class="label">Fund Cluster:</span> 
                <span class="value border-bottom-line">__________________</span>
            </div>
        </div>

        <table class="par-table">
            <tr>
                <td colspan="3" class="label-cell">
                    <strong>Class/Type:</strong> 
                    <span class="data-text">{{ asset.get_asset_class_display }}</span>
                </td>
                <td colspan="2" class="label-cell" style="border-left: 2px solid #000;">
                    <strong>Property Number:</strong> 
                    <span class="data-text">{{ asset.property_number }}</span>
                </td>
            </tr>

            <tr>
                <td colspan="5" class="label-cell" style="height: 60px; vertical-align: top;">
                    <strong>Description:</strong><br>
                    <div class="data-text mt-1" style="font-weight: normal;">
                        {{ asset.description }}
                    </div>
                </td>
            </tr>

            <tr class="text-center bold-headers">
                <td width="12%">Date</td>
                <td width="20%">Nature of Repair</td>
                <td width="33%">Details / Work Done</td>
                <td width="20%">Service Provider</td>
                <td width="15%">Amount/Cost</td>
            </tr>

            {% for log in service_logs %}
            <tr class="data-row">
                <td class="text-center">{{ log.service_date|date:"m/d/Y" }}</td>
                <td class="text-center">{{ log.get_service_type_display }}</td>
                <td>{{ log.description }}</td>
                <td class="text-center">{{ log.service_provider }}</td>
                <td class="text-end pe-2">
                    {% if log.cost > 0 %}₱{{ log.cost|intcomma }}{% else %}-{% endif %}
                </td>
            </tr>
            {% empty %}
            <tr class="data-row" style="height: 100px;">
                <td colspan="5" class="text-center text-muted fst-italic">No service history recorded.</td>
            </tr>
            {% endfor %}

            {% for i in "12345" %} 
            <tr class="data-row" style="height: 25px;">
                <td>&nbsp;</td><td></td><td></td><td></td><td></td>
            </tr>
            {% endfor %}

            <tr class="bold-headers">
                <td colspan="4" class="text-end pe-3"><strong>TOTAL MAINTENANCE COST:</strong></td>
                <td class="text-end pe-2"><strong>₱{{ total_cost|intcomma }}</strong></td>
            </tr>
        </table>

        <table class="par-table" style="border-top: none;">
            <tr>
                <td width="50%" class="section-header">CERTIFIED CORRECT:</td>
                <td width="50%" class="section-header" style="border-left: 2px solid #000;">NOTED BY:</td>
            </tr>
            
            <tr style="height: 90px; vertical-align: bottom;">
                <td class="p-2 text-center">
                    <div class="border-top border-dark mx-4 pt-1">&nbsp;</div>
                    <div class="small">Accountable Officer</div>
                </td>
                <td class="p-2 text-center" style="border-left: 2px solid #000;">
                    <div class="border-top border-dark mx-4 pt-1">&nbsp;</div>
                    <div class="small">Signature over Printed Name</div>
                </td>
            </tr>
        </table>
    </div>
</div>

<style>
    /* ==========================================================================
       1. SCREEN PREVIEW STYLES (Overlay & Portrait Dimensions)
       ========================================================================== */
    
    /* Overlay to hide sidebar/navbar */
    #preview-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: #525659; /* PDF Viewer Grey */
        z-index: 99999;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .preview-controls {
        width: 100%;
        background-color: #323639;
        padding: 10px 20px;
        position: sticky;
        top: 0;
        z-index: 100000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    /* The Paper Sheet (Portrait A4) */
    #print-area {
        background: white;
        width: 210mm; /* A4 Portrait Width */
        min-height: 297mm; /* A4 Portrait Height */
        margin: 30px auto;
        padding: 10mm 15mm; /* Minimum Margins: Top/Bot 10mm, Left/Right 15mm */
        box-shadow: 0 0 15px rgba(0,0,0,0.5);
        font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
        color: #000;
        box-sizing: border-box;
    }

    .max-w-A4 { max-width: 210mm; }

    /* ==========================================================================
       2. PRINT MEDIA QUERIES (Printer Output)
       ========================================================================== */
    @media print {
        @page {
            size: A4 portrait; /* Force Portrait */
            margin: 5mm;       /* Minimum Margins for Printer */
        }

        body * {
            visibility: hidden;
        }
        
        #preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            background: white;
            display: block;
            overflow: visible;
        }

        .no-print {
            display: none !important;
        }

        #print-area, #print-area * {
            visibility: visible;
        }

        #print-area {
            position: absolute;
            top: 0;
            left: 0;
            margin: 0;
            padding: 0; /* Reset padding to let @page handle edges or keep minimal */
            width: 100%;
            box-shadow: none;
            max-width: none;
        }
    }

    /* ==========================================================================
       3. DOCUMENT TYPOGRAPHY & LAYOUT
       ========================================================================== */
    .print-header { text-align: center; margin-bottom: 15px; }
    .print-header h4 { margin: 0; font-weight: bold; font-size: 13px; text-transform: uppercase; }
    .print-header h5 { margin: 2px 0; font-weight: bold; font-size: 10px; }
    .print-header h3 { margin-top: 10px; font-weight: bold; font-size: 15px; font-style: italic; }

    .print-meta { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 11px; }
    .row-meta { width: 48%; display: flex; }
    .row-meta .label { font-weight: bold; white-space: nowrap; margin-right: 5px; }
    .row-meta .value { flex-grow: 1; border-bottom: 1px solid #000; }
    
    .par-table { width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 10px; }
    .par-table td { border: 1px solid #000; padding: 4px 5px; vertical-align: middle; }
    
    .bold-headers td { font-weight: bold; text-align: center; background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; }
    .section-header { text-align: center; font-weight: bold; background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; }
    .label-cell { background-color: #fff; }
    .data-text { font-family: Arial, sans-serif; font-weight: bold; margin-left: 5px; }
</style>

<script>
    // Optional: Auto-print on load
    // window.onload = function() { setTimeout(function() { window.print(); }, 800); }
</script>
{% endblock %}