{% extends 'layout.html' %}
{% load humanize %}

{% block content %}
<div class="container-fluid fade-in mb-5">
    
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
        <nav aria-label="breadcrumb" class="mb-3 mb-md-0">
            <ol class="breadcrumb m-0">
                <li class="breadcrumb-item"><a href="{% url 'asset_list' %}" class="text-decoration-none">All Assets</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ asset.property_number }}</li>
            </ol>
        </nav>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="{% url 'print_service_log' asset.pk %}" target="_blank" class="btn btn-primary shadow-sm">
                <i class="fas fa-file-invoice me-2"></i>Print Service Record
            </a>
            
            <button onclick="window.print()" class="btn btn-primary shadow-sm">
                <i class="fas fa-print me-2"></i>Print Property Card
            </button>
        </div>
    </div>

    <div class="row screen-only">
        
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-body-tertiary py-3 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold m-0 text-primary">{{ asset.name }}</h5>
                    <span class="badge 
                        {% if asset.status == 'SERVICEABLE' %}bg-success
                        {% elif asset.status == 'UNSERVICEABLE' %}bg-danger
                        {% else %}bg-warning{% endif %}">
                        {{ asset.get_status_display }}
                    </span>
                </div>
                
                <div class="card-body p-4">
                    <h6 class="text-uppercase text-body-secondary small fw-bold mb-3 border-bottom pb-2">Basic Information</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="small text-muted">Property Number</label>
                            <div class="fw-semibold text-body-emphasis">{{ asset.property_number }}</div>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-muted">Assigned Office</label>
                            <div class="fw-semibold text-body-emphasis">{{ asset.assigned_office }}</div>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-muted">Date Acquired</label>
                            <div>{{ asset.date_acquired }}</div>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-muted">Acquisition Cost</label>
                            <div class="fw-bold text-success">₱{{ asset.acquisition_cost|intcomma }}</div>
                        </div>
                    </div>

                    <h6 class="text-uppercase text-body-secondary small fw-bold mb-3 border-bottom pb-2">Classification</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="small text-muted">Class</label>
                            <div>{{ asset.get_asset_class_display }}</div>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-muted">Nature</label>
                            <div>{{ asset.get_asset_nature_display }}</div>
                        </div>
                        <div class="col-md-12">
                            <label class="small text-muted">Full Description</label>
                            <div class="bg-body-tertiary p-3 rounded text-body-secondary small">
                                {{ asset.description|default:"No description provided." }}
                            </div>
                        </div>
                    </div>

                    <h6 class="text-uppercase text-body-secondary small fw-bold mb-3 border-bottom pb-2">Accountability</h6>
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="small text-muted">Accountable Officer</label>
                            <div class="fw-semibold text-body-emphasis">
                                {{ asset.accountable_firstname }} {{ asset.accountable_middle_initial }} {{ asset.accountable_surname }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-body-tertiary py-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold m-0"><i class="fas fa-tools me-2 text-secondary"></i>Service & Maintenance History</h6>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addServiceModal">
                        <i class="fas fa-plus me-1"></i> Add Log
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr>
                                    <th class="ps-4">Date</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Provider</th>
                                    <th>Cost</th>
                                    <th>Docs</th>
                                    <th class="text-end pe-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="small">
                                {% for log in service_logs %}
                                <tr>
                                    <td class="ps-4 fw-bold">{{ log.service_date|date:"M d, Y" }}</td>
                                    <td>
                                        <span class="badge bg-secondary text-light rounded-pill">{{ log.get_service_type_display }}</span>
                                    </td>
                                    <td>{{ log.description|truncatechars:40 }}</td>
                                    <td>{{ log.service_provider }}</td>
                                    <td>{% if log.cost > 0 %}₱{{ log.cost|intcomma }}{% else %}-{% endif %}</td>
                                    <td>
                                        {% if log.service_document %}
                                            <a href="{{ log.service_document.url }}" target="_blank" class="text-primary" title="View Document">
                                                <i class="fas fa-paperclip"></i>
                                            </a>
                                        {% endif %}
                                    </td>
                                    <td class="text-end pe-4">
                                        {% if user.is_staff %}
                                        <a href="{% url 'delete_service_log' log.pk %}" 
                                           class="text-danger" 
                                           onclick="return confirm('Are you sure you want to delete this log?');"
                                           title="Delete Record">
                                            <i class="fas fa-trash-alt"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted">
                                        No maintenance or repair records found.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-body-tertiary fw-bold small text-body-secondary">
                    <i class="fas fa-barcode me-2"></i>SERIAL NUMBER
                </div>
                <div class="card-body text-center bg-body-tertiary">
                    {% if asset.image_serial %}
                        <img src="{{ asset.image_serial.url }}" class="img-fluid rounded shadow-sm" alt="Serial">
                    {% else %}
                        <div class="text-muted py-4 opacity-50">
                            <i class="fas fa-camera fa-3x mb-2"></i><br>No Photo
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-body-tertiary fw-bold small text-body-secondary">
                    <i class="fas fa-stethoscope me-2"></i>PHYSICAL CONDITION
                </div>
                <div class="card-body text-center bg-body-tertiary">
                    {% if asset.image_condition %}
                        <img src="{{ asset.image_condition.url }}" class="img-fluid rounded shadow-sm" alt="Condition">
                    {% else %}
                        <div class="text-muted py-4 opacity-50">
                            <i class="fas fa-camera fa-3x mb-2"></i><br>No Photo
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-body-tertiary fw-bold small text-body-secondary">
                    <i class="fas fa-folder-open me-2"></i>DOCUMENTS
                </div>
                <div class="card-body">
                    {% if asset.attachment %}
                        <div class="d-flex align-items-center p-2 border rounded mb-2 bg-light">
                            <div class="me-3 text-primary">
                                <i class="fas fa-file-alt fa-2x"></i>
                            </div>
                            <div class="flex-grow-1 text-truncate">
                                <div class="small fw-bold text-dark text-truncate" title="{{ asset.attachment.name }}" style="max-width: 180px;">
                                    {{ asset.attachment.name }}
                                </div>
                                <div class="small text-muted" style="font-size: 10px;">Attached File</div>
                            </div>
                            <a href="{{ asset.attachment.url }}" target="_blank" class="btn btn-sm btn-outline-primary" title="View/Download">
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-3 small">
                            <i class="fas fa-file mb-2 opacity-50"></i><br>No documents attached.
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="addServiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="fas fa-tools me-2"></i>Add Service Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'add_service_log' asset.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Service Date</label>
                            {{ form.service_date }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Type</label>
                            {{ form.service_type }}
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold text-muted">Description / Work Done</label>
                            {{ form.description }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Service Provider</label>
                            {{ form.service_provider }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Cost</label>
                            {{ form.cost }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Next Schedule (Optional)</label>
                            {{ form.next_service_date }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Attachment (Optional)</label>
                            {{ form.service_document }}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Record</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="print-area">
    <div class="print-header">
        <h4>University of the Philippines</h4>
        <h5>System Supply and Property Management Office</h5>
        <br>
        <h3>- Property Card (PAR Asset) -</h3>
    </div>

    <div class="print-meta">
        <div class="left"><strong>Entity Name:</strong> {{ asset.name }}</div>
        <div class="right"><strong>Fund Cluster:</strong> __________________</div>
    </div>

    <table class="par-table">
        <tr>
            <td colspan="4" class="label-cell">
                <strong>Class/Type:</strong> 
                <span class="data-field">{{ asset.get_asset_class_display|default:"ICT EQUIPMENT" }}</span>
            </td>
            <td colspan="4" class="label-cell" style="border-left: 2px solid #000;">
                <strong>Property Number:</strong> 
                <span class="data-field">{{ asset.property_number }}</span>
            </td>
        </tr>

        <tr>
            <td colspan="8" class="label-cell" style="height: 80px; vertical-align: top;">
                <strong>Description:</strong><br>
                <div class="data-field mt-2" style="width: 98%;">
                    {{ asset.name }} - {{ asset.description }}
                </div>
            </td>
        </tr>

        <tr class="text-center bold-headers">
            <td rowspan="2" width="10%">Date</td>
            <td rowspan="2" width="12%">Reference/<br>PAR No.</td>
            <td width="8%">Receipt</td>
            <td colspan="2" width="25%">Issue/Transfer/Digital:</td>
            <td width="8%">Balance</td>
            <td rowspan="2" width="15%">Amount</td>
            <td rowspan="2">Remarks</td>
        </tr>
        <tr class="text-center bold-headers">
            <td>QTY</td>
            <td>QTY</td>
            <td>Issue/Office</td>
            <td>QTY</td>
        </tr>

        <tr class="text-center data-row" style="height: 50px;">
            <td>{{ asset.date_acquired|date:"m/d/Y" }}</td>
            <td>{{ asset.property_number }}</td>
            <td>1</td>
            <td>1</td>
            <td>{{ asset.assigned_office }}</td>
            <td>1</td>
            <td>₱{{ asset.acquisition_cost|intcomma }}</td>
            <td></td>
        </tr>
        
        <tr class="data-row" style="height: 30px;"><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
    </table>

    <table class="par-table" style="border-top: none;">
        <tr>
            <td width="50%" class="section-header">RECEIVED BY:</td>
            <td width="50%" class="section-header" style="border-left: 2px solid #000;">TRANSFERRED TO:</td>
        </tr>
        
        <tr>
            <td class="p-2">
                <div class="d-flex align-items-center">
                    <span class="me-2 fw-bold">Surname:</span>
                    <div class="data-field flex-grow-1"></div>
                </div>
            </td>
            <td class="p-2" style="border-left: 2px solid #000;">
                <div class="d-flex align-items-center">
                    <span class="me-2 fw-bold">Surname:</span>
                    <div class="data-field flex-grow-1"></div>
                </div>
            </td>
        </tr>

        <tr>
            <td class="p-2">
                <div class="d-flex align-items-center">
                    <span class="me-2 fw-bold">First Name:</span>
                    <div class="data-field flex-grow-1"></div>
                </div>
            </td>
            <td class="p-2" style="border-left: 2px solid #000;">
                <div class="d-flex align-items-center">
                    <span class="me-2 fw-bold">First Name:</span>
                    <div class="data-field flex-grow-1"></div>
                </div>
            </td>
        </tr>
    </table>
</div>

<style>
    #print-area { display: none; }

    @media print {
        body * { visibility: hidden; }
        .screen-only, nav, button, footer, .btn { display: none !important; }

        #print-area, #print-area * { visibility: visible; }
        
        #print-area {
            display: block; position: absolute;
            top: 0; left: 0; width: 100%;
            background: white; color: black;
            padding: 20px; font-family: Arial, sans-serif;
        }

        /* HEADER STYLES - Updated for Palatino & Size */
        .print-header { 
            text-align: center; 
            margin-bottom: 20px; 
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif; 
        }
        .print-header h4 { 
            margin: 0; 
            font-weight: bold; 
            font-size: 14px; 
        }
        .print-header h5 { 
            margin: 5px 0 0 0; 
            font-weight: bold; 
            font-size: 11px; 
        }
        .print-header h3 { 
            margin: 10px 0 0 0; 
            font-weight: bold; 
            font-size: 16px; 
        }

        .print-meta { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; }

        .par-table { width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 11px; }
        .par-table td { border: 1px solid #000; padding: 4px; vertical-align: middle; }
        .bold-headers td { font-weight: bold; }
        .section-header { text-align: center; font-weight: bold; padding: 8px; border-bottom: 1px solid #000; }

        .data-field {
            background-color: #f2f2f2 !important; 
            padding: 2px 5px;
            display: inline-block;
            min-width: 50px;
            height: 18px; 
            border-radius: 2px;
            -webkit-print-color-adjust: exact; 
            print-color-adjust: exact;
        }
    }
</style>
{% endblock %}