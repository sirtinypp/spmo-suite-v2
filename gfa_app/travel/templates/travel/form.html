{% extends 'travel/base.html' %}
{% load static %}

{% block extra_head %}
<style>
    .hero-pattern {
        background-color: #0f172a;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231e293b' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    .hidden-visually {
        display: none;
        opacity: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="-mt-10 -mx-4 sm:-mx-6 lg:-mx-8">
    <!-- Header Hero -->
    <div class="hero-pattern h-48 w-full relative rounded-b-[3rem] overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-blue-900 to-slate-900 opacity-90"></div>
        <div class="relative max-w-7xl mx-auto px-6 pt-12 md:px-12 text-center text-white">
            <h2 class="text-3xl font-black tracking-tight italic uppercase">LIPAD<span
                    class="text-blue-500 not-italic">.</span> Flight Request</h2>
            <p class="text-slate-300 text-sm mt-2">Fill out the official GFA requisition details below.</p>
        </div>
    </div>

    <div class="max-w-5xl mx-auto px-6 md:px-12 -mt-16 relative z-10 pb-12">
        <div class="bg-white rounded-[2.5rem] shadow-2xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
            <form method="post" id="bookingForm" class="p-8 md:p-12 space-y-12">
                {% csrf_token %}

                {% if form.errors %}
                <div class="rounded-2xl bg-red-50 p-4 mb-6 border border-red-100 flex items-center gap-3">
                    <i class="fas fa-exclamation-circle text-red-500"></i>
                    <h3 class="text-xs font-bold text-red-800">Please correct the errors indicated below.</h3>
                </div>
                {% endif %}

                <!-- Section 1: Traveler -->
                <section>
                    <div class="flex items-center gap-3 mb-8">
                        <div
                            class="w-8 h-8 rounded-xl bg-blue-600 flex items-center justify-center text-white text-xs font-bold shadow-lg shadow-blue-500/20">
                            1</div>
                        <h3 class="text-sm font-black text-slate-900 uppercase tracking-widest">Traveler Information
                        </h3>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div class="space-y-1">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest pl-1">Official
                                Name</label>
                            <input type="text" name="full_name" value="{{ form.full_name.value|default:'' }}"
                                class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all text-sm font-medium"
                                placeholder="E.g. Juan De La Cruz">
                        </div>
                        <div class="space-y-1">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest pl-1">Employee
                                ID</label>
                            <input type="text" name="employee_id" value="{{ form.employee_id.value|default:'' }}"
                                class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all text-sm font-medium">
                        </div>
                        <div class="space-y-1">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest pl-1">Personal
                                Email</label>
                            <input type="email" name="email" value="{{ form.email.value|default:'' }}"
                                class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all text-sm font-medium">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest pl-1">UP
                                Mail Address</label>
                            <input type="email" name="up_mail" value="{{ form.up_mail.value|default:'' }}"
                                class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all text-sm font-medium">
                        </div>
                        <div class="space-y-1">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest pl-1">Contact
                                Number</label>
                            <input type="text" name="contact_number" value="{{ form.contact_number.value|default:'' }}"
                                class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all text-sm font-medium">
                        </div>
                        <div class="space-y-1">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest pl-1">Mother
                                Unit</label>
                            <select name="mother_unit"
                                class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all text-sm font-medium appearance-none">
                                {% for value, label in form.fields.mother_unit.choices %}
                                <option value="{{ value }}" {% if form.mother_unit.value==value %}selected{% endif %}>{{
                                    label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </section>

                <!-- Section 2: Travel Details -->
                <section>
                    <div class="flex items-center gap-3 mb-8">
                        <div
                            class="w-8 h-8 rounded-xl bg-blue-600 flex items-center justify-center text-white text-xs font-bold shadow-lg shadow-blue-500/20">
                            2</div>
                        <h3 class="text-sm font-black text-slate-900 uppercase tracking-widest">Travel Itinerary</h3>
                    </div>

                    <div class="space-y-6">
                        <div class="space-y-1">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest pl-1">Detailed
                                Purpose of Travel</label>
                            <textarea name="purpose" rows="3"
                                class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all text-sm font-medium">{{ form.purpose.value|default:'' }}</textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-end">
                            <div class="space-y-1">
                                <label
                                    class="block text-[10px] font-black text-blue-600 uppercase tracking-widest pl-1">Trip
                                    Classification</label>
                                <select name="trip_type"
                                    class="w-full px-5 py-3 bg-blue-50 border border-blue-100 text-blue-900 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all text-sm font-bold">
                                    {% for value, label in form.fields.trip_type.choices %}
                                    <option value="{{ value }}" {% if form.trip_type.value==value %}selected{% endif %}>
                                        {{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div id="simple-flight-view"
                            class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50/50 p-6 rounded-3xl border border-dashed border-slate-200">
                            <div class="space-y-1">
                                <label
                                    class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Origin</label>
                                <input type="text" name="origin" value="{{ form.origin.value|default:'Manila' }}"
                                    class="w-full px-4 py-2 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium">
                            </div>
                            <div class="space-y-1">
                                <label
                                    class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Destination</label>
                                <input type="text" name="destination_details"
                                    value="{{ form.destination_details.value|default:'' }}"
                                    class="w-full px-4 py-2 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label
                                        class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Departure
                                        Date</label>
                                    <input type="date" name="departure_date"
                                        value="{{ form.departure_date.value|date:'Y-m-d'|default:'' }}"
                                        class="w-full px-4 py-2 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium">
                                </div>
                                <div class="space-y-1">
                                    <label
                                        class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Time</label>
                                    <input type="time" name="departure_time"
                                        value="{{ form.departure_time.value|time:'H:i'|default:'' }}"
                                        class="w-full px-4 py-2 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium">
                                </div>
                            </div>
                            <div id="return-date-container" class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label
                                        class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Return
                                        Date</label>
                                    <input type="date" name="return_date"
                                        value="{{ form.return_date.value|date:'Y-m-d'|default:'' }}"
                                        class="w-full px-4 py-2 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium">
                                </div>
                                <div class="space-y-1">
                                    <label
                                        class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Time</label>
                                    <input type="time" name="return_time"
                                        value="{{ form.return_time.value|time:'H:i'|default:'' }}"
                                        class="w-full px-4 py-2 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium">
                                </div>
                            </div>
                        </div>

                        <div id="multi-city-view" class="hidden-visually space-y-4">
                            <div class="bg-slate-50 border border-slate-200 rounded-3xl p-8">
                                <h4 class="text-xs font-black text-slate-900 mb-6 uppercase tracking-widest">Flight
                                    Segments</h4>
                                <div id="segments-container" class="space-y-4"></div>
                                <button type="button" id="add-segment-btn"
                                    class="mt-6 flex items-center gap-2 text-xs font-black text-blue-600 hover:text-blue-800 transition-colors uppercase tracking-widest">
                                    <i class="fas fa-plus-circle text-lg"></i> Add Flight Segment
                                </button>
                            </div>
                        </div>

                        <div class="flex items-center gap-4 p-5 bg-emerald-50 border border-emerald-100 rounded-2xl">
                            <input type="checkbox" name="is_official" {% if form.is_official.value %}checked{% endif %}
                                class="w-6 h-6 text-emerald-600 border-emerald-200 rounded-lg focus:ring-emerald-500">
                            <label class="text-xs font-black text-emerald-800 uppercase tracking-widest">Confirm: This
                                Travel is Official and Authorized</label>
                        </div>
                    </div>
                </section>

                <!-- Section 3: Preferences -->
                <section>
                    <div class="flex items-center gap-3 mb-8">
                        <div
                            class="w-8 h-8 rounded-xl bg-blue-600 flex items-center justify-center text-white text-xs font-bold shadow-lg shadow-blue-500/20">
                            3</div>
                        <h3 class="text-sm font-black text-slate-900 uppercase tracking-widest">Logistics & Preferences
                        </h3>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-1">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest pl-1">Preferred
                                Airline</label>
                            <select name="airline"
                                class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium">
                                {% for value, label in form.fields.airline.choices %}
                                <option value="{{ value }}" {% if form.airline.value==value %}selected{% endif %}>{{
                                    label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest pl-1">Cabin
                                Class</label>
                            <select name="seat_class"
                                class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium">
                                {% for value, label in form.fields.seat_class.choices %}
                                <option value="{{ value }}" {% if form.seat_class.value==value %}selected{% endif %}>{{
                                    label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest pl-1">Baggage
                                Preference</label>
                            <select name="baggage_type"
                                class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium">
                                {% for value, label in form.fields.baggage_type.choices %}
                                <option value="{{ value }}" {% if form.baggage_type.value==value %}selected{% endif %}>
                                    {{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="flex items-center gap-4 pt-4">
                            <input type="checkbox" name="avail_insurance" {% if form.avail_insurance.value %}checked{%
                                endif %} class="w-6 h-6 text-blue-600 rounded-lg">
                            <label class="text-xs font-black text-slate-600 uppercase tracking-widest">Include Travel
                                Insurance</label>
                        </div>
                        <div class="md:col-span-2 space-y-1">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest pl-1">Dietary
                                or Seat Requests</label>
                            <textarea name="special_requests" rows="2"
                                class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium">{{ form.special_requests.value|default:'' }}</textarea>
                        </div>
                    </div>
                </section>

                <!-- Section 4: Submission -->
                <div class="bg-blue-900 p-8 md:p-10 rounded-[2.5rem] shadow-2xl text-white space-y-6">
                    <div class="flex items-start gap-4">
                        <div class="mt-1">
                            <input type="checkbox" name="agreed_to_policy" {% if form.agreed_to_policy.value %}checked{%
                                endif %}
                                class="w-6 h-6 rounded-lg bg-white/10 border-white/20 text-blue-500 focus:ring-offset-blue-900 border-2">
                        </div>
                        <p class="text-xs font-medium text-slate-300 leading-relaxed italic">
                            I hereby certify that the information provided is true and correct, and that this travel is
                            in accordance with UP System government policies and procurement procedures.
                        </p>
                    </div>

                    <div class="flex justify-center md:justify-end pt-4">
                        <button type="submit"
                            class="bg-blue-500 hover:bg-blue-400 text-white font-black py-4 px-10 rounded-2xl shadow-xl shadow-blue-500/30 transition-all transform active:scale-95 flex items-center gap-3 uppercase tracking-widest text-xs">
                            Generate Requisition Slip <i class="fas fa-file-invoice-dollar text-lg"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tripTypeSelect = document.querySelector('[name="trip_type"]');
        const simpleView = document.getElementById('simple-flight-view');
        const multiCityView = document.getElementById('multi-city-view');
        const returnContainer = document.getElementById('return-date-container');
        const returnInputs = returnContainer.querySelectorAll('input');
        const segmentsContainer = document.getElementById('segments-container');
        const addSegmentBtn = document.getElementById('add-segment-btn');
        const mainOrigin = document.querySelector('[name="origin"]');
        const mainDest = document.querySelector('[name="destination_details"]');
        const mainDepDate = document.querySelector('[name="departure_date"]');
        const mainDepTime = document.querySelector('[name="departure_time"]');

        function updateFormView() {
            const type = tripTypeSelect.value;
            if (type === 'MULTI_CITY') {
                simpleView.classList.add('hidden-visually'); simpleView.style.display = 'none';
                multiCityView.classList.remove('hidden-visually'); multiCityView.style.display = 'block';
                simpleView.querySelectorAll('input').forEach(i => i.removeAttribute('required'));
                if (segmentsContainer.children.length === 0) addSegment();
            } else {
                simpleView.classList.remove('hidden-visually'); simpleView.style.display = 'grid';
                multiCityView.classList.add('hidden-visually'); multiCityView.style.display = 'none';
                mainOrigin.setAttribute('required', 'required'); mainDest.setAttribute('required', 'required');
                mainDepDate.setAttribute('required', 'required'); mainDepTime.setAttribute('required', 'required');
                if (type === 'ONE_WAY') {
                    returnContainer.classList.add('hidden-visually'); returnInputs.forEach(i => { i.value = ''; i.removeAttribute('required'); });
                } else {
                    returnContainer.classList.remove('hidden-visually'); returnInputs.forEach(i => i.setAttribute('required', 'required'));
                }
            }
        }

        function createSegmentRow(index) {
            const div = document.createElement('div');
            div.className = "grid grid-cols-1 md:grid-cols-12 gap-3 items-center bg-white p-4 border border-slate-200 rounded-2xl shadow-sm segment-row relative group";
            div.innerHTML = `
                <div class="md:col-span-3">
                    <label class="block text-[8px] font-black text-slate-400 uppercase mb-1">Origin</label>
                    <input type="text" placeholder="Origin" class="mc-origin w-full px-3 py-2 text-xs border border-slate-100 rounded-lg bg-slate-50 focus:bg-white focus:ring-1 focus:ring-blue-500 font-bold uppercase transition-all">
                </div>
                <div class="md:col-span-3">
                    <label class="block text-[8px] font-black text-slate-400 uppercase mb-1">Destination</label>
                    <input type="text" placeholder="Destination" class="mc-dest w-full px-3 py-2 text-xs border border-slate-100 rounded-lg bg-slate-50 focus:bg-white focus:ring-1 focus:ring-blue-500 font-bold uppercase transition-all">
                </div>
                <div class="md:col-span-3">
                    <label class="block text-[8px] font-black text-slate-400 uppercase mb-1">Date</label>
                    <input type="date" class="mc-date w-full px-3 py-2 text-xs border border-slate-100 rounded-lg bg-slate-50 focus:bg-white focus:ring-1 focus:ring-blue-500 font-bold transition-all">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-[8px] font-black text-slate-400 uppercase mb-1">Time</label>
                    <input type="time" class="mc-time w-full px-3 py-2 text-xs border border-slate-100 rounded-lg bg-slate-50 focus:bg-white focus:ring-1 focus:ring-blue-500 font-bold transition-all">
                </div>
                <div class="md:col-span-1 flex justify-center pt-4 md:pt-0">
                    ${index > 0 ? `<button type="button" class="text-red-400 hover:text-red-600 remove-seg transition-colors"><i class="fas fa-trash-alt"></i></button>` : ''}
                </div>
            `;
            if (index > 0) { div.querySelector('.remove-seg').addEventListener('click', function () { div.remove(); }); }
            return div;
        }

        function addSegment() { const count = segmentsContainer.children.length; segmentsContainer.appendChild(createSegmentRow(count)); }

        document.getElementById('bookingForm').addEventListener('submit', function (e) {
            if (tripTypeSelect.value === 'MULTI_CITY') {
                const rows = document.querySelectorAll('.segment-row');
                let origins = [], dests = [], dates = [], times = [];
                let fullText = "MULTI-CITY ITINERARY:\n";
                rows.forEach((row, idx) => {
                    const o = row.querySelector('.mc-origin').value;
                    const d = row.querySelector('.mc-dest').value;
                    const dt = row.querySelector('.mc-date').value;
                    const tm = row.querySelector('.mc-time').value;
                    origins.push(o); dests.push(d); dates.push(dt); times.push(tm);
                    fullText += `${idx + 1}. ${o} to ${d} on ${dt} @ ${tm}\n`;
                });
                if (origins.length > 0) {
                    mainOrigin.value = "Multi-City: " + origins.join(" / "); mainDest.value = dests.join(" / "); mainDepDate.value = dates[0]; mainDepTime.value = times[0] || "00:00";
                    const specialReq = document.querySelector('[name="special_requests"]'); specialReq.value = fullText + "\n" + specialReq.value;
                }
            }
        });

        addSegmentBtn.addEventListener('click', addSegment);
        tripTypeSelect.addEventListener('change', updateFormView);
        updateFormView();
    });
</script>
{% endblock %}