{% extends 'travel/base.html' %}
{% load static %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .hero-pattern {
        background-color: #0f172a;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231e293b' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
</style>
{% endblock %}

{% block content %}
<div class="-mt-10 -mx-4 sm:-mx-6 lg:-mx-8">
    <!-- Header Hero -->
    <div class="hero-pattern h-80 w-full relative rounded-b-[3rem] overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-blue-900 to-slate-900 opacity-90"></div>
        <div class="relative max-w-7xl mx-auto px-6 pt-12 md:px-12 flex justify-between items-start h-full">
            <div class="text-white">
                <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-2 block">Executive
                    Portal</span>
                <h2 class="text-4xl font-black tracking-tight mb-2 italic">LIPAD<span
                        class="text-blue-500 not-italic">.</span> Dashboard</h2>
                <p class="text-slate-300 text-sm max-w-2xl">Real-time GFA procurement tracking, budget monitoring, and
                    document review.</p>
            </div>

            <div class="hidden sm:block bg-white/5 backdrop-blur-md border border-white/10 px-4 py-2 rounded-2xl">
                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">System Health</div>
                <div class="flex items-center gap-2 text-emerald-400 font-bold text-xs uppercase">
                    <span class="relative flex h-2 w-2">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    Operational
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="max-w-7xl mx-auto px-6 md:px-12 -mt-24 relative z-10 pb-12 space-y-10">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- Total Bookings -->
            <div
                class="bg-white p-6 rounded-3xl shadow-2xl shadow-slate-200/50 border border-slate-100 flex flex-col justify-between h-40 hover:-translate-y-1 transition-all duration-300">
                <div class="flex justify-between items-start">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Total Bookings</p>
                    <div
                        class="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center border border-blue-100">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-4xl font-black text-slate-900 tracking-tighter">{{ total_reqs }}</h3>
                    <p class="text-[10px] text-slate-400 font-bold mt-1">LIPAD System Total</p>
                </div>
            </div>

            <!-- Pending Action -->
            <div
                class="bg-white p-6 rounded-3xl shadow-2xl shadow-slate-200/50 border border-slate-100 flex flex-col justify-between h-40 hover:-translate-y-1 transition-all duration-300">
                <div class="flex justify-between items-start">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Pending Action</p>
                    <div
                        class="w-10 h-10 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center border border-amber-100">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-4xl font-black text-amber-600 tracking-tighter">{{ pending_reqs }}</h3>
                    <p class="text-[10px] text-amber-500 font-bold mt-1">Requires Attention</p>
                </div>
            </div>

            <!-- PAL Balance -->
            <div
                class="bg-white p-6 rounded-3xl shadow-2xl shadow-slate-200/50 border border-slate-100 flex flex-col justify-between h-40 hover:-translate-y-1 transition-all duration-300">
                <div class="flex justify-between items-start">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">PAL Balance</p>
                    <div
                        class="w-10 h-10 bg-red-50 text-red-600 rounded-xl flex items-center justify-center border border-red-100">
                        <i class="fas fa-credit-card"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-2xl font-black {{ pal_display.color }} tracking-tighter font-mono">₱ {{
                        pal_display.val }}</h3>
                    <p class="text-[10px] text-slate-400 font-bold mt-1 uppercase">Live GFA Credits</p>
                </div>
            </div>

            <!-- CEBUPAC Balance -->
            <div
                class="bg-white p-6 rounded-3xl shadow-2xl shadow-slate-200/50 border border-slate-100 flex flex-col justify-between h-40 hover:-translate-y-1 transition-all duration-300">
                <div class="flex justify-between items-start">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">CebPac Balance</p>
                    <div
                        class="w-10 h-10 bg-yellow-50 text-yellow-600 rounded-xl flex items-center justify-center border border-yellow-100">
                        <i class="fas fa-wallet"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-2xl font-black {{ ceb_display.color }} tracking-tighter font-mono">₱ {{
                        ceb_display.val }}</h3>
                    <p class="text-[10px] text-slate-400 font-bold mt-1 uppercase">Live GFA Credits</p>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-8 rounded-[2rem] shadow-xl border border-slate-100">
                <div class="flex items-center gap-3 mb-8">
                    <div class="w-1.5 h-6 bg-blue-600 rounded-full"></div>
                    <h3 class="font-black text-slate-900 uppercase tracking-tight">Top Destinations</h3>
                </div>
                <div class="relative h-64 w-full"><canvas id="destChart"></canvas></div>
            </div>
            <div class="bg-white p-8 rounded-[2rem] shadow-xl border border-slate-100">
                <div class="flex items-center gap-3 mb-8">
                    <div class="w-1.5 h-6 bg-emerald-600 rounded-full"></div>
                    <h3 class="font-black text-slate-900 uppercase tracking-tight">Requests by Office</h3>
                </div>
                <div class="relative h-64 w-full flex justify-center"><canvas id="officeChart"></canvas></div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="bg-white rounded-[2rem] shadow-2xl border border-slate-100 overflow-hidden">
            <div
                class="px-8 py-6 border-b border-slate-50 bg-slate-50/50 flex flex-col md:flex-row justify-between items-center gap-4">
                <h3 class="font-black text-slate-900 uppercase tracking-tight text-sm">Recent Transactions Log</h3>
                <form method="GET" action="" class="flex gap-2 w-full md:w-auto">
                    <div class="relative flex-grow">
                        <input type="text" name="q" value="{{ search_query|default:'' }}"
                            placeholder="Search Ref No or Name..."
                            class="text-xs bg-white border border-slate-200 rounded-xl px-4 py-2.5 pl-10 focus:ring-2 focus:ring-blue-500 outline-none w-full md:w-80 transition-all">
                        <i
                            class="fas fa-search text-slate-400 absolute left-4 top-1/2 -translate-y-1/2 text-[10px]"></i>
                    </div>
                    <button type="submit"
                        class="bg-slate-900 hover:bg-slate-800 text-white px-6 py-2.5 rounded-xl text-xs font-bold transition-all shadow-lg shadow-slate-900/10">Search</button>
                </form>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left">
                    <thead
                        class="bg-slate-50/50 border-b border-slate-100 text-slate-400 uppercase text-[10px] font-black tracking-widest">
                        <tr>
                            <th class="px-8 py-4">Ref ID</th>
                            <th class="px-8 py-4">Traveler / Office</th>
                            <th class="px-8 py-4">Documents</th>
                            <th class="px-8 py-4">Status</th>
                            <th class="px-8 py-4 text-right">Administrative Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50">
                        {% for t in transactions %}
                        <tr class="hover:bg-slate-50/80 transition-all group">
                            <td class="px-8 py-5">
                                <span
                                    class="font-mono font-bold text-blue-600 bg-blue-50 border border-blue-100 px-3 py-1 rounded-lg text-[10px]">
                                    GFA-{{ t.id|stringformat:"06d" }}
                                </span>
                                <div class="text-[9px] text-slate-400 mt-2 font-bold uppercase">{{ t.created_at|date:"M
                                    d, Y" }}</div>
                            </td>
                            <td class="px-8 py-5">
                                <div class="font-bold text-slate-900 text-sm">{{ t.full_name }}</div>
                                <div class="text-[10px] text-slate-400 font-medium">{{ t.get_unit_office_display }}
                                </div>
                            </td>
                            <td class="px-8 py-5">
                                {% if t.doc_signed_slip %}
                                <a href="{{ t.doc_signed_slip.url }}" target="_blank"
                                    class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-800 text-xs font-bold transition-colors">
                                    <i class="fas fa-file-pdf"></i> View Slip
                                </a>
                                {% else %}
                                <span class="text-slate-300 text-[10px] italic font-medium">No Attachment</span>
                                {% endif %}
                            </td>
                            <td class="px-8 py-5">
                                <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest shadow-sm border
                                    {% if t.status == 'PENDING' %}bg-amber-50 border-amber-100 text-amber-600
                                    {% elif t.status == 'APPROVED' %}bg-blue-50 border-blue-100 text-blue-600
                                    {% elif t.status == 'BOOKED' %}bg-emerald-50 border-emerald-100 text-emerald-600
                                    {% else %}bg-slate-50 border-slate-100 text-slate-500{% endif %}">
                                    {{ t.status }}
                                </span>
                            </td>
                            <td class="px-8 py-5 text-right">
                                {% if t.status == 'PENDING' %}
                                <form action="{% url 'update_status' t.id %}" method="POST"
                                    class="flex justify-end gap-2">
                                    {% csrf_token %}
                                    <button name="action" value="approve"
                                        class="bg-emerald-600 text-white text-[10px] font-bold px-4 py-2 rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-500/20">Approve</button>
                                    <button name="action" value="return"
                                        class="bg-white border border-red-100 text-red-600 text-[10px] font-bold px-4 py-2 rounded-xl hover:bg-red-50 transition">Return</button>
                                </form>
                                {% elif t.status == 'APPROVED' %}
                                <a href="{% url 'admin_attach_ticket' t.id %}"
                                    class="inline-flex items-center gap-2 bg-blue-600 text-white text-[10px] font-bold px-4 py-2 rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-500/20">
                                    <i class="fas fa-ticket-alt"></i> Issue Ticket
                                </a>
                                {% else %}
                                <div
                                    class="flex items-center justify-end gap-2 text-slate-400 text-[10px] font-bold uppercase">
                                    <i class="fas fa-lock text-[8px]"></i> Locked
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="px-8 py-20 text-center">
                                <div class="flex flex-col items-center gap-2 opacity-20">
                                    <i class="fas fa-folder-open text-4xl"></i>
                                    <p class="font-bold text-sm">No transactions found</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const destLabels = JSON.parse('{{ dest_labels|safe }}');
    const destCounts = JSON.parse('{{ dest_counts|safe }}');
    const officeLabels = JSON.parse('{{ office_labels|safe }}');
    const officeCounts = JSON.parse('{{ office_counts|safe }}');

    Chart.defaults.font.family = "'Outfit', sans-serif";
    Chart.defaults.color = '#94a3b8';
    const upColors = ['#1e40af', '#1e3a8a', '#3b82f6', '#0f172a', '#64748b'];

    new Chart(document.getElementById('destChart'), {
        type: 'bar',
        data: {
            labels: destLabels,
            datasets: [{
                label: 'Flights',
                data: destCounts,
                backgroundColor: '#1e40af',
                borderRadius: 12,
                barThickness: 24
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                x: { grid: { display: false } }
            }
        }
    });

    new Chart(document.getElementById('officeChart'), {
        type: 'doughnut',
        data: {
            labels: officeLabels,
            datasets: [{
                data: officeCounts,
                backgroundColor: upColors,
                borderWidth: 0,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '80%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: { size: 10, weight: 'bold' }
                    }
                }
            }
        }
    });
</script>
{% endblock %}